---
title: "ML course - Part 1b - PLS"
author: "Said el Bouhaddani"
date: '`r Sys.Date()`'
output:
  rmdformats::material:
    highlight: kate
    self_contained: no
bibliography: references.bib
---

```{r global_options, include=FALSE}
library(knitr)
library(rmdformats)

opts_chunk$set(fig.path='Figs/', eval=TRUE,
               echo=TRUE, warning=F, message=F, dev='png', dpi=600)
```

# Introduction

This is a file with exercises for the ML 2020 course. The exercises are divided into two parts. This is part 1b: Partial Least Squares. 

## PLS recap
PLS can be applied to two datasets, by calculating the left and right singular vectors of $Y^\top X$. In R this would be `svd(crossprod(Y,X), 2, 2)` for a PLS with two components. The $W$ and $C$ are then given by adding `$v` or `$u`. 



# Exercises

- Rerun the example given during the PLS lecture. 
- Modify the R code below to plot the PLS loadings rather than the PCA ones. For example, `pca.rna = svd(rna, 0, 2)` becomes `pls.both = svd(crossprod(metab,rna), 2, 2)`, and then `pls.rna = pls.both$v`. Of course, you can also assign the weights to `pca.rna`, so you don't have to substitute all `pca.rna` with `pls.rna`. For ``pca.metab` you will need to switch the position of $X$ and $Y$, or put a $u$ instead of a $v$.


```{r Load RNA data}
load("rna_metab.RData")

pca.rna = svd(crossprod(metab,rna), 0, 2)
pca.metab <- svd(crossprod(rna,metab), 0, 2)


library(magrittr)
library(ggplot2)
library(gridExtra)
library(OmicsPLS)
library(illuminaHumanv3.db) # BiocManager::install("illuminaHumanv3.db")
# Color names
LLmodule <- c("ILMN_1690209",'ILMN_1766551', 'ILMN_1749131', 'ILMN_1688423', 
              'ILMN_2102670', 'ILMN_1792323', 'ILMN_1899034', 'ILMN_1806721', 
              'ILMN_1695530', 'ILMN_1726114', 'ILMN_1751625', 'ILMN_1726114', 
              'ILMN_1753648', 'ILMN_1779043')
LLnr <- which(colnames(rna) %in% LLmodule)
rna_genenames <- select(illuminaHumanv3.db, 
                        keys = colnames(rna)[LLnr], 
                        keytype = "PROBEID", columns = "SYMBOL")[,2]

name_col <- 1 + sapply( #First sapply loops over column names
  X = colnames(metab),
  FUN = function(arg){
    crossprod(
      c(1, 1, 3, 4, 5), # Weights to be used as categories
      sapply(c("VLDL", "LDL", "IDL", "HDL","FA"), # metabolite classes
             function(arg2){grepl(arg2, arg)} # compare class of metabolites
      )
    )
    }
  )
name_col <- factor(name_col, 
                   levels = c(3,2,4:6,1), 
                   labels = c("VLDL", "LDL", "IDL", "HDL","FA","Other"))

# alpmetab <- loadings(fit, "Yjoint", 1:2) %>%  # Retreive loadings
#   abs %>% # Absolute loading values for positive weights
#   rowSums %>% # Sum over the components
#   sqrt + (name_col!="Other") # Take square root

######### Plot loadings with ggplot ###
p_metab <- ggplot(data.frame(x = pca.metab$v[,1], y = pca.metab$v[, 2]), aes(x = x, y = y)) + 
##################### Add all layers ###
  theme_bw() +
  coord_fixed(ratio = 1, xlim=c(-.2,.2),ylim=c(-.2,.2)) +
  geom_point( # Set color and size
    aes(col=name_col, size = I(1+(name_col%in%c("VLDL","HDL"))), 
          shape = name_col),show.legend = T) +
  theme(legend.position="right") +
  scale_color_discrete(name="Metabolite\nGroup",
                       labels=c("VLDL", "LDL", "IDL", "HDL","FA","Other")) +
  guides(size=F) + scale_shape_discrete(name="Metabolite\nGroup",
                                labels=c("VLDL", "LDL", "IDL", "HDL","FA","Other")) +
  scale_shape_manual(name="Metabolite\nGroup", values=c(15,3,4,17,5,6)) + 
  labs(title = "Metabolite joint loadings",
       x = "First Joint Loadings", y = "Second Joint Loadings") +
  theme(plot.title = element_text(face='bold'),
        legend.title=element_text(face='bold')) + 
  geom_hline(yintercept = 0) + geom_vline(xintercept = 0)

alprna <- pca.rna$v %>% raise_to_power(2) %>% rowSums
alprna[-(order(alprna,decreasing=T)[1:10])] = 0
alprna <- sign(alprna)
toprna <- which(alprna>0)
names_rna <- mapIds(illuminaHumanv3.db, 
       keys = colnames(rna)[toprna], 
       keytype = "PROBEID", 
       column = "SYMBOL",
       multiVals = 'first')
names_rna[which(is.na(names_rna))] <- "?"
######### Plot loadings with OmicsPLS plot method ###
p_rna <- ggplot(data.frame(x = pca.rna$v[, 1], y = pca.rna$v[, 2]), 
                aes(x = x, y = y),
                alpha = alprna,
                aes(label = NA)) +
    ##################### Add all layers ###
  theme_bw() +
  coord_fixed(.8, c(-.15,.15),c(-.15,.15)) +
  geom_point(alpha = 0.5, col = 'grey') +
  geom_point(data = data.frame(x = pca.rna$v[LLnr, 1], y = pca.rna$v[LLnr, 2]),
             shape = 2, col = 2, size = 2) + 
  geom_text(data = data.frame(x=pca.rna$v[toprna,1],y=pca.rna$v[toprna,2]),
            hjust = rep(c(1, 0), length.out = length(toprna)),
            aes(label = names_rna)) + 
  labs(title = "Transcript joint loadings",
       x = "First Joint Loadings", y = "Second Joint Loadings") +
  theme(plot.title = element_text(face='bold')) + 
  geom_hline(yintercept = 0) + geom_vline(xintercept = 0)

## Finally plot both plots in one figure.
grid.arrange(p_metab, p_rna, ncol=2)

```



# Solutions

- See the code on slide 10
- The fastest way is to modify the definition of `pca.rna` and `pca.metab` to `pca.rna = svd(crossprod(metab,rna), 0, 2)` and `pca.metab <- svd(crossprod(rna,metab), 0, 2)`.




# References




